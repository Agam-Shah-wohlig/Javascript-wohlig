<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Listing</title>
    <link rel="stylesheet" href="/css/products.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('partials/navbar') %>

    <!-- Header with Search and Cart -->
    <header class="site-header">
        <div class="search-bar">
            <form action="/products" method="GET">
                <input 
                    type="text" 
                    name="search" 
                    placeholder="Search products…" 
                    value="<%= filters?.search || '' %>"
                >
                <button type="submit">Search</button>
            </form>
        </div>
    </header>

    <h1>Our Collection</h1>

    <div class="page-container">
        <!-- Sidebar Filters -->
        <aside>
            <form action="/products/filter" method="GET" class="sidebar">
                
                <!-- Preserve search term -->
                <% if (filters?.search) { %>
                    <input type="hidden" name="search" value="<%= filters.search %>">
                <% } %>

                <!-- Category Filter -->
                <div class="filter-section">
                    <h4>Category</h4>
                    <% 
                        const selectedCategories = filters?.category ? 
                            (Array.isArray(filters.category) ? filters.category : [filters.category]) : [];
                    %>
                    <label>
                        <input type="checkbox" name="category" value="Casual Shirts" 
                            <%= selectedCategories.includes('Casual Shirts') ? 'checked' : '' %>>
                        Casual Shirts
                    </label>
                    <label>
                        <input type="checkbox" name="category" value="T-Shirts"
                            <%= selectedCategories.includes('T-Shirts') ? 'checked' : '' %>>
                        T-Shirts
                    </label>
                    <label>
                        <input type="checkbox" name="category" value="Jeans"
                            <%= selectedCategories.includes('Jeans') ? 'checked' : '' %>>
                        Jeans
                    </label>
                    <label>
                        <input type="checkbox" name="category" value="Formal Pants"
                            <%= selectedCategories.includes('Formal Pants') ? 'checked' : '' %>>
                        Formal Pants
                    </label>
                </div>

                <!-- Brand Filter -->
                <div class="filter-section">
                    <h4>Brand</h4>
                    <% 
                        const selectedBrands = filters?.brand ? 
                            (Array.isArray(filters.brand) ? filters.brand : [filters.brand]) : [];
                    %>
                    <label>
                        <input type="checkbox" name="brand" value="Raymond"
                            <%= selectedBrands.includes('Raymond') ? 'checked' : '' %>>
                        Raymond
                    </label>
                    <label>
                        <input type="checkbox" name="brand" value="Blackberrys"
                            <%= selectedBrands.includes('Blackberrys') ? 'checked' : '' %>>
                        Blackberrys
                    </label>
                    <label>
                        <input type="checkbox" name="brand" value="Louis Philippe"
                            <%= selectedBrands.includes('Louis Philippe') ? 'checked' : '' %>>
                        Louis Philippe
                    </label>
                </div>

                <!-- Color Filter -->
                <div class="filter-section">
                    <h4>Color</h4>
                    <% 
                        const selectedColors = filters?.color ? 
                            (Array.isArray(filters.color) ? filters.color : [filters.color]) : [];
                    %>
                    <% ['Red', 'Blue', 'Black', 'White', 'Grey', 'Green', 'Navy'].forEach(color => { %>
                        <label>
                            <input type="checkbox" name="color" value="<%= color %>"
                                <%= selectedColors.includes(color) ? 'checked' : '' %>>
                            <%= color %>
                        </label>
                    <% }); %>
                </div>

                <!-- Size Filter -->
                <div class="filter-section">
                    <h4>Size</h4>
                    <% 
                        const selectedSizes = filters?.size ? 
                            (Array.isArray(filters.size) ? filters.size : [filters.size]) : [];
                    %>
                    <% ['S', 'M', 'L', 'XL', 'XXL'].forEach(size => { %>
                        <label>
                            <input type="checkbox" name="size" value="<%= size %>"
                                <%= selectedSizes.includes(size) ? 'checked' : '' %>>
                            <%= size %>
                        </label>
                    <% }); %>
                </div>

                <!-- Price Range Filter -->
                <div class="filter-section">
                    <h4>Price Range</h4>
                    <% 
                        const selectedPrices = filters?.price ? 
                            (Array.isArray(filters.price) ? filters.price : [filters.price]) : [];
                    %>
                    <label>
                        <input type="checkbox" name="price" value="0-500"
                            <%= selectedPrices.includes('0-500') ? 'checked' : '' %>>
                        ₹0 - ₹500
                    </label>
                    <label>
                        <input type="checkbox" name="price" value="500-1500"
                            <%= selectedPrices.includes('500-1500') ? 'checked' : '' %>>
                        ₹500 - ₹1500
                    </label>
                    <label>
                        <input type="checkbox" name="price" value="1500-3000"
                            <%= selectedPrices.includes('1500-3000') ? 'checked' : '' %>>
                        ₹1500 - ₹3000
                    </label>
                    <label>
                        <input type="checkbox" name="price" value="3000-5000"
                            <%= selectedPrices.includes('3000-5000') ? 'checked' : '' %>>
                        ₹3000 - ₹5000
                    </label>
                </div>

                <!-- Sorting -->
                <div class="filter-section">
                    <h4>Sort By</h4>
                    <label>
                        <input type="radio" name="sort" value="high"
                            <%= filters?.sort === 'high' ? 'checked' : '' %>>
                        Price High → Low
                    </label>
                    <label>
                        <input type="radio" name="sort" value="low"
                            <%= filters?.sort === 'low' ? 'checked' : '' %>>
                        Price Low → High
                    </label>
                </div>

                <button type="submit" class="btn">Apply Filters</button>
                <a href="/products" class="btn" style="text-align: center; display: block; margin-top: 10px;">Clear All</a>
            </form>
        </aside>

        <!-- Product Grid -->
        <main class="product-container">
            <% if (products.length === 0) { %>
                <p style="grid-column: 1/-1; text-align: center; padding: 40px;">
                    No products found matching your criteria.
                </p>
            <% } else { %>
                <% products.forEach(product => { %>
                    <div class="product-card">
                        <!-- Product Image -->
                        <img 
                            id="product-img-<%= product._id %>" 
                            src="<%= product.images %>" 
                            alt="<%= product.title %>"
                            loading="lazy"
                        >

                        <!-- Title & Initial Price -->
                        <div class="product-title"><%= product.title %></div>
                        <div class="price" id="price-<%= product._id %>">
                            ₹<%= product.variants[0]?.price || 0 %>
                        </div>

                        <!-- Variant Selection -->
                        <% if (product.variants.length > 0) { %>
                            <label for="variant-<%= product._id %>">Variant:</label>
                            <select id="variant-<%= product._id %>" class="variant-select">
                                <% product.variants.forEach(variant => { %>
                                    <% 
                                        const attrs = [];
                                        for (let key in variant.attributes) {
                                            attrs.push(`${key}: ${variant.attributes[key]}`);
                                        }
                                    %>
                                    <option 
                                        value="<%= variant._id %>" 
                                        data-stock="<%= variant.stock %>"
                                        data-price="<%= variant.price %>"
                                        data-image="<%= variant.image %>">
                                        <%= attrs.join(', ') %> - ₹<%= variant.price %>
                                    </option>
                                <% }); %>
                            </select>

                            <!-- Quantity Input -->
                            <input 
                                type="number" 
                                id="quantity-<%= product._id %>" 
                                value="1" 
                                min="1"
                                max="<%= product.variants[0]?.stock || 1 %>"
                                class="quantity-input"
                            >

                            <!-- Add to Cart Button -->
                            <button 
                                class="btn-add-cart" 
                                data-product-id="<%= product._id %>"
                                <%= product.variants[0]?.stock === 0 ? 'disabled' : '' %>>
                                <%= product.variants[0]?.stock === 0 ? 'Out of Stock' : 'Add to Cart' %>
                            </button>
                        <% } else { %>
                            <p>No variants available</p>
                        <% } %>
                    </div>
                <% }); %>
            <% } %>
        </main>
    </div>

    <script>
        // Update image, price, and button when variant changes
        document.querySelectorAll('.variant-select').forEach(select => {
            select.addEventListener('change', function() {
                const productId = this.id.replace('variant-', '');
                const selectedOption = this.options[this.selectedIndex];
                
                // Update image
                const img = document.getElementById('product-img-' + productId);
                if (selectedOption.dataset.image) {
                    img.src = selectedOption.dataset.image;
                }
                
                // Update price
                const priceDiv = document.getElementById('price-' + productId);
                priceDiv.textContent = '₹' + selectedOption.dataset.price;
                
                // Update quantity max and button state
                const stock = parseInt(selectedOption.dataset.stock);
                const quantityInput = document.getElementById('quantity-' + productId);
                const addButton = document.querySelector(`button[data-product-id="${productId}"]`);
                
                quantityInput.max = stock;
                if (quantityInput.value > stock) {
                    quantityInput.value = stock;
                }
                
                if (stock === 0) {
                    addButton.disabled = true;
                    addButton.textContent = 'Out of Stock';
                } else {
                    addButton.disabled = false;
                    addButton.textContent = 'Add to Cart';
                }
            });
        });

        // Add to Cart functionality
        document.querySelectorAll('.btn-add-cart').forEach(button => {
            button.addEventListener('click', async function() {
                const productId = this.dataset.productId;
                const variantSelect = document.getElementById('variant-' + productId);
                const variantId = variantSelect ? variantSelect.value : null;
                const quantityInput = document.getElementById('quantity-' + productId);
                const quantity = parseInt(quantityInput.value) || 1;

                if (!variantId) {
                    alert('Please select a variant');
                    return;
                }

                try {
                    const response = await fetch('/cart/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId, variantId, quantity })
                    });

                    if (response.status === 401) {
                    // Not logged in → redirect
                    alert('Failed to add to cart! Login Required!')
                    window.location.href = "/auth/login";
                    return;
                    }
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert('Added to cart successfully!');
                    } else {
                        alert(data.error || 'Failed to add to cart! Login Required!');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Something went wrong. Please try again.');
                }
            });
        });
    </script>
</body>
</html>