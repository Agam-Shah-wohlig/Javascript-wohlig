<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - SHOPKART</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/profile.css">
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="profile-container">
        <h1>My Profile</h1>

        <!-- Profile Sections -->
        <div class="profile-content">
            
            <!-- Personal Details Section -->
            <section class="profile-section">
                <div class="section-header">
                    <h2>Personal Details</h2>
                    <button class="btn-edit" onclick="toggleEdit('personal')">Edit</button>
                </div>

                <form id="personal-form" action="/user/update-profile" method="POST">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input 
                                type="text" 
                                name="fullName" 
                                value="<%= user.fullName || '' %>" 
                                readonly
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input 
                                type="email" 
                                name="email" 
                                value="<%= user.email || '' %>" 
                                readonly
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label>Phone Number</label>
                            <input 
                                type="tel" 
                                name="phone" 
                                value="<%= user.phone || '' %>" 
                                readonly
                                pattern="[0-9]{10}"
                            >
                        </div>

                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input 
                                type="date" 
                                name="dateOfBirth" 
                                value="<%= user.dateOfBirth ? new Date(user.dateOfBirth).toISOString().split('T')[0] : '' %>" 
                                readonly
                            >
                        </div>
                    </div>

                    <div class="form-actions" style="display: none;">
                        <button type="submit" class="btn-save">Save Changes</button>
                        <button type="button" class="btn-cancel" onclick="toggleEdit('personal')">Cancel</button>
                    </div>
                </form>
            </section>

            <!-- Shipping Addresses Section -->
            <section class="profile-section">
                <div class="section-header">
                    <h2>Shipping Addresses</h2>
                    <div class="header-actions">
                        <% if (addresses && addresses.length > 0) { %>
                            <button class="btn-edit" onclick="toggleEditAddress('<%= addresses[0]._id %>')">Edit</button>
                            <button class="btn-add" onclick="showAddAddressForm()">Add New</button>
                        <% } else { %>
                            <button class="btn-add" onclick="showAddAddressForm()">Add Address</button>
                        <% } %>
                    </div>
                </div>

                <!-- Add Address Form (Hidden by default) -->
                <form id="add-address-form" action="/user/add-address" method="POST" style="display: none;">
                    <% if (typeof next !== 'undefined') { %>
                        <input type="hidden" name="next" value="<%= next %>">
                    <% } %>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Label (Home, Office, etc.)</label>
                            <input type="text" name="label" placeholder="e.g., Home" required>
                        </div>

                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" name="fullName" placeholder="Recipient name" required>
                        </div>

                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" name="phone" placeholder="10 digit number" pattern="[0-9]{10}" required>
                        </div>

                        <div class="form-group full-width">
                            <label>Street Address</label>
                            <input type="text" name="street" placeholder="House no., Street name" required>
                        </div>

                        <div class="form-group">
                            <label>City</label>
                            <input type="text" name="city" required>
                        </div>

                        <div class="form-group">
                            <label>State</label>
                            <input type="text" name="state" required>
                        </div>

                        <div class="form-group">
                            <label>Postal Code</label>
                            <input type="text" name="postalCode" pattern="[0-9]{6}" required>
                        </div>

                        <div class="form-group">
                            <label>Country</label>
                            <input type="text" name="country" value="India" required>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-save">Add Address</button>
                        <button type="button" class="btn-cancel" onclick="hideAddAddressForm()">Cancel</button>
                    </div>
                </form>

                <!-- Existing Addresses -->
                <div class="addresses-list">
                    <% if (addresses && addresses.length > 0) { %>
                        <% addresses.forEach((address) => { %>
                            <div class="address-card" id="address-<%= address._id %>">
                                <div class="address-header">
                                    <div class="address-label"><%= address.label %></div>
                                </div>
                                
                                <!-- Display Mode -->
                                <div class="address-display" id="display-<%= address._id %>">
                                    <p><strong><%= address.fullName %></strong></p>
                                    <p><%= address.phone %></p>
                                    <p><%= address.street %></p>
                                    <p><%= address.city %>, <%= address.state %> - <%= address.postalCode %></p>
                                    <p><%= address.country %></p>
                                    
                                    <div class="address-actions">
                                        <button class="btn-edit-small" onclick="toggleEditAddress('<%= address._id %>')">Edit</button>
                                        <form action="/user/delete-address/<%= address._id %>" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this address?')">
                                            <button type="submit" class="btn-delete-small">Delete</button>
                                        </form>
                                    </div>
                                </div>

                                <!-- Edit Mode -->
                                <form class="address-edit" id="edit-<%= address._id %>" action="/user/update-address" method="POST" style="display: none;">
                                    <input type="hidden" name="addressId" value="<%= address._id %>">
                                    
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Label</label>
                                            <input type="text" name="label" value="<%= address.label %>" required>
                                        </div>

                                        <div class="form-group">
                                            <label>Full Name</label>
                                            <input type="text" name="fullName" value="<%= address.fullName %>" required>
                                        </div>

                                        <div class="form-group">
                                            <label>Phone Number</label>
                                            <input type="tel" name="phone" value="<%= address.phone %>" pattern="[0-9]{10}" required>
                                        </div>

                                        <div class="form-group full-width">
                                            <label>Street Address</label>
                                            <input type="text" name="street" value="<%= address.street %>" required>
                                        </div>

                                        <div class="form-group">
                                            <label>City</label>
                                            <input type="text" name="city" value="<%= address.city %>" required>
                                        </div>

                                        <div class="form-group">
                                            <label>State</label>
                                            <input type="text" name="state" value="<%= address.state %>" required>
                                        </div>

                                        <div class="form-group">
                                            <label>Postal Code</label>
                                            <input type="text" name="postalCode" value="<%= address.postalCode %>" pattern="[0-9]{6}" required>
                                        </div>

                                        <div class="form-group">
                                            <label>Country</label>
                                            <input type="text" name="country" value="<%= address.country %>" required>
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn-save">Update Address</button>
                                        <button type="button" class="btn-cancel" onclick="toggleEditAddress('<%= address._id %>')">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p class="no-addresses">No addresses saved yet. Click "Add Address" to create your first shipping address!</p>
                    <% } %>
                </div>
            </section>

            <!-- Account Security (Optional) -->
            <section class="profile-section">
                <div class="section-header">
                    <h2>Account Security</h2>
                </div>
                <a href="/user/change-password" class="btn-secondary">Change Password</a>
            </section>

        </div>
    </div>

    <script>
        // Toggle edit mode for personal details
        function toggleEdit(formType) {
            const formId = formType === 'personal' ? 'personal-form' : 'address-form';
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('input:not([type="hidden"])');
            const actions = form.querySelector('.form-actions');
            const editBtn = form.closest('.profile-section').querySelector('.btn-edit');

            const isReadonly = inputs[0].hasAttribute('readonly');

            inputs.forEach(input => {
                if (isReadonly) {
                    input.removeAttribute('readonly');
                    input.classList.add('editable');
                } else {
                    input.setAttribute('readonly', true);
                    input.classList.remove('editable');
                }
            });

            if (isReadonly) {
                actions.style.display = 'flex';
                editBtn.textContent = 'Cancel';
            } else {
                actions.style.display = 'none';
                editBtn.textContent = 'Edit';
                window.location.reload();
            }
        }

        // Show add address form
        function showAddAddressForm() {
            const form = document.getElementById('add-address-form');
            const addressesList = document.querySelector('.addresses-list');
            
            // Hide all address cards when adding new
            if (addressesList) {
                const cards = addressesList.querySelectorAll('.address-card');
                cards.forEach(card => card.style.display = 'none');
            }
            
            form.style.display = 'block';
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Hide add address form
        function hideAddAddressForm() {
            const form = document.getElementById('add-address-form');
            const addressesList = document.querySelector('.addresses-list');
            
            form.style.display = 'none';
            
            // Show all address cards again
            if (addressesList) {
                const cards = addressesList.querySelectorAll('.address-card');
                cards.forEach(card => card.style.display = 'block');
            }
        }

        // Toggle edit mode for individual address
        function toggleEditAddress(addressId) {
            const displayDiv = document.getElementById('display-' + addressId);
            const editForm = document.getElementById('edit-' + addressId);
            const addForm = document.getElementById('add-address-form');

            // Hide add form if it's open
            if (addForm && addForm.style.display === 'block') {
                hideAddAddressForm();
            }

            if (displayDiv.style.display === 'none') {
                displayDiv.style.display = 'block';
                editForm.style.display = 'none';
            } else {
                displayDiv.style.display = 'none';
                editForm.style.display = 'block';
                editForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    </script>
</body>
</html>